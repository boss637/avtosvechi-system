# MIGRATION / ALEMBIC RULES (AVTOSVECHI / AUTOSHOP)

## Current DB status
- Alembic current/head: 39f9b3be4c47

## Why Alembic `env.py` has filters
The production database contains legacy tables and historical constraints created before the current
SQLAlchemy model set was finalized.

If Alembic compares DB schema with models without filtering, `alembic check` / `revision --autogenerate`
attempt to generate destructive operations (drop legacy tables) and noisy operations (rename constraints,
recreate indexes, flip nullable) that are not part of planned changes.

## Managed vs legacy schema
### Managed (actively evolved by Alembic)
- products
- stores
- users
- movements
- current_inventory
- product_abc_class

### Legacy (must not be altered by autogenerate/check)
- inventory (document/journal table; not SSOT for current stock)
- stock_snapshots (legacy snapshot table)
- vehicles (legacy vehicle structure)

## Known autogenerate noise filtered out
To keep `alembic check` meaningful, we ignore:
- FK constraint diffs (names / ondelete) for: movements, current_inventory
- index diffs for: users, stores, product_abc_class (and the tables above)
- unique constraint diffs for: users, stores, product_abc_class
- nullable diffs for: users.username, users.hashed_password, product_abc_class.calculated_at

## Operational rule
Before any DB change:
1) Ensure `alembic current`, `alembic heads`, `alembic check` are green inside the api container.
2) Only then run `alembic revision --autogenerate`.
3) Never apply autogenerated migrations that include drop_table/drop_column unless explicitly planned.
