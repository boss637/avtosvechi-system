#!/bin/bash
# –£–ú–ù–´–ô –ú–û–ù–ò–¢–û–†–ò–ù–ì AVTOSVECHI –° –ê–õ–ï–†–¢–ê–ú–ò
# –í–µ—Ä—Å–∏—è: 2.0

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TELEGRAM_BOT_TOKEN="8206084673:AAHNu7tEEm7FTNMXSz63nhVIkzjYYSg2p_w"
TELEGRAM_CHAT_ID="6838202455"
LOG_FILE="/home/oleg/avtosvechi_monitor_$(date +%Y%m%d).log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# –¶–≤–µ—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
send_telegram() {
    local message="$1"
    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d text="${message}" \
        -d parse_mode="HTML" \
        > /dev/null 2>&1
}

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$TIMESTAMP] $1" >> "$LOG_FILE"
    echo -e "$2$1${NC}"
}

# –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏
log "üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ AVTOSVECHI" "$BLUE"
log "–í—Ä–µ–º—è: $TIMESTAMP" "$BLUE"

# –ú–∞—Å—Å–∏–≤—ã –¥–ª—è —Å–±–æ—Ä–∞ –ø—Ä–æ–±–ª–µ–º
CRITICAL_ERRORS=()
WARNINGS=()
HEALTHY_SERVICES=()

# 1. –ü–†–û–í–ï–†–ö–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –°–ï–†–í–ò–°–û–í
log "" "$NC"
log "1. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–ï–†–í–ò–°–´:" "$BLUE"

check_critical() {
    local name="$1"
    local container="$2"
    
    if docker ps --filter "name=$container" --format "{{.Status}}" | grep -q "Up"; then
        log "   ‚úÖ $name: —Ä–∞–±–æ—Ç–∞–µ—Ç" "$GREEN"
        HEALTHY_SERVICES+=("$name")
        return 0
    else
        log "   üî¥ $name: –ù–ï –†–ê–ë–û–¢–ê–ï–¢" "$RED"
        CRITICAL_ERRORS+=("$name")
        return 1
    fi
}

check_critical "Redis" "avtosvechi_redis"
check_critical "Telegram Bot" "telegram-bot-fixed"
check_critical "–î–æ–∫–µ—Ä-–¥–µ–º–æ–Ω" "dummy"  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫–µ—Ä–∞
if ! docker info > /dev/null 2>&1; then
    log "   üî¥ Docker: –ù–ï –†–ê–ë–û–¢–ê–ï–¢" "$RED"
    CRITICAL_ERRORS+=("Docker")
else
    log "   ‚úÖ Docker: —Ä–∞–±–æ—Ç–∞–µ—Ç" "$GREEN"
    HEALTHY_SERVICES+=("Docker")
fi

# 2. –ü–†–û–í–ï–†–ö–ê –í–ê–ñ–ù–´–• –°–ï–†–í–ò–°–û–í
log "" "$NC"
log "2. –í–ê–ñ–ù–´–ï –°–ï–†–í–ò–°–´:" "$BLUE"

check_important() {
    local name="$1"
    local container="$2"
    
    if docker ps --filter "name=$container" --format "{{.Status}}" | grep -q "Up"; then
        log "   ‚úÖ $name: —Ä–∞–±–æ—Ç–∞–µ—Ç" "$GREEN"
        HEALTHY_SERVICES+=("$name")
        return 0
    else
        log "   üü° $name: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" "$YELLOW"
        WARNINGS+=("$name")
        return 1
    fi
}

check_important "Prometheus" "autoshop_prometheus"
check_important "Grafana" "autoshop_grafana"
check_important "AlertManager" "autoshop_alertmanager"
check_important "Telegram Proxy" "telegram-proxy-1"

# 3. –ü–†–û–í–ï–†–ö–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –°–ï–†–í–ò–°–û–í
log "" "$NC"
log "3. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–ï–†–í–ò–°–´:" "$BLUE"

check_optional() {
    local name="$1"
    local container="$2"
    
    if docker ps --filter "name=$container" --format "{{.Status}}" | grep -q "Up"; then
        log "   ‚úÖ $name: —Ä–∞–±–æ—Ç–∞–µ—Ç" "$GREEN"
        return 0
    else
        log "   ‚ö™ $name: –Ω–µ –∑–∞–ø—É—â–µ–Ω" "$NC"
        return 1
    fi
}

check_optional "Node Exporter" "adf2e6e24025_autoshop_node_exporter"
check_optional "cAdvisor" "946eb9702fa1_autoshop_cadvisor"

# 4. –ü–†–û–í–ï–†–ö–ê –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò
log "" "$NC"
log "4. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò:" "$BLUE"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
if docker exec avtosvechi_redis redis-cli ping 2>/dev/null | grep -q PONG; then
    log "   ‚úÖ Redis: –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping" "$GREEN"
else
    log "   üî¥ Redis: –ù–ï –û–¢–í–ï–ß–ê–ï–¢" "$RED"
    CRITICAL_ERRORS+=("Redis ping")
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus
if curl -s --connect-timeout 5 http://localhost:9091/-/healthy > /dev/null 2>&1; then
    log "   ‚úÖ Prometheus: –∑–¥–æ—Ä–æ–≤" "$GREEN"
else
    log "   üü° Prometheus: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" "$YELLOW"
    WARNINGS+=("Prometheus –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Grafana
if curl -s --connect-timeout 5 http://localhost:3000/api/health > /dev/null 2>&1; then
    log "   ‚úÖ Grafana: —Ä–∞–±–æ—Ç–∞–µ—Ç" "$GREEN"
else
    log "   üü° Grafana: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞" "$YELLOW"
    WARNINGS+=("Grafana –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
fi

# 5. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´
log "" "$NC"
log "5. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´:" "$BLUE"

TOTAL_CONTAINERS=$(docker ps -q | wc -l 2>/dev/null || echo "0")
RUNNING_CONTAINERS=$(docker ps --filter "status=running" -q | wc -l 2>/dev/null || echo "0")
RESTARTING_CONTAINERS=$(docker ps --filter "status=restarting" -q | wc -l 2>/dev/null || echo "0")
FAILED_CONTAINERS=$(docker ps --filter "status=exited" -q | wc -l 2>/dev/null || echo "0")

log "   üìä –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤—Å–µ–≥–æ: $TOTAL_CONTAINERS" "$NC"
log "   ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏—Ö: $RUNNING_CONTAINERS" "$GREEN"

if [ $RESTARTING_CONTAINERS -gt 0 ]; then
    log "   üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—â–∏—Ö—Å—è: $RESTARTING_CONTAINERS" "$YELLOW"
    docker ps --filter "status=restarting" --format "     ‚Ä¢ {{.Names}} ({{.Status}})" >> "$LOG_FILE"
fi

if [ $FAILED_CONTAINERS -gt 0 ]; then
    log "   ‚ùå –£–ø–∞–≤—à–∏—Ö: $FAILED_CONTAINERS" "$RED"
fi

# –†–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã
MEM_USED=$(free -m | awk 'NR==2{printf "%d", $3}')
MEM_TOTAL=$(free -m | awk 'NR==2{printf "%d", $2}')
MEM_PERCENT=$((MEM_USED * 100 / MEM_TOTAL))

CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
DISK_USAGE=$(df -h / | awk 'NR==2{print $5}')

log "   üíæ –ü–∞–º—è—Ç—å: ${MEM_USED}MB/${MEM_TOTAL}MB (${MEM_PERCENT}%)" "$NC"
log "   üìà –ù–∞–≥—Ä—É–∑–∫–∞ CPU: $CPU_LOAD" "$NC"
log "   üíø –î–∏—Å–∫ (/): $DISK_USAGE" "$NC"

# 6. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –û–¢–ß–ï–¢–ê –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
log "" "$NC"
log "6. –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢:" "$BLUE"

TOTAL_CRITICAL=${#CRITICAL_ERRORS[@]}
TOTAL_WARNINGS=${#WARNINGS[@]}
TOTAL_HEALTHY=${#HEALTHY_SERVICES[@]}

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
log "   –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫: $TOTAL_CRITICAL" "$([ $TOTAL_CRITICAL -gt 0 ] && echo "$RED" || echo "$GREEN")"
log "   –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: $TOTAL_WARNINGS" "$([ $TOTAL_WARNINGS -gt 0 ] && echo "$YELLOW" || echo "$GREEN")"
log "   –†–∞–±–æ—Ç–∞—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: $TOTAL_HEALTHY" "$GREEN"

# 7. –õ–û–ì–ò–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
if [ $TOTAL_CRITICAL -gt 0 ]; then
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    log "üî¥ –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò!" "$RED"
    
    CRITICAL_LIST=$(printf "‚Ä¢ %s\n" "${CRITICAL_ERRORS[@]}")
    WARNING_LIST=$(printf "‚Ä¢ %s\n" "${WARNINGS[@]}")
    
    TELEGRAM_MESSAGE="üö® <b>AVTOSVECHI - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò!</b>

<b>–í—Ä–µ–º—è:</b> $(date '+%d.%m.%Y %H:%M:%S')
<b>–°–µ—Ä–≤–µ—Ä:</b> $(hostname)
<b>IP:</b> $(hostname -I | awk '{print $1}')

<b>üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ ($TOTAL_CRITICAL):</b>
$CRITICAL_LIST

<b>üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ($TOTAL_WARNINGS):</b>
$([ $TOTAL_WARNINGS -gt 0 ] && echo "$WARNING_LIST" || echo "–ù–µ—Ç")

<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $RUNNING_CONTAINERS/$TOTAL_CONTAINERS
‚Ä¢ –ü–∞–º—è—Ç—å: ${MEM_PERCENT}%
‚Ä¢ –ù–∞–≥—Ä—É–∑–∫–∞: $CPU_LOAD

<b>üö® –î–ï–ô–°–¢–í–ò–Ø:</b>
1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: docker-compose logs
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: docker-compose restart
4. –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç: $LOG_FILE

<b>üåê –°—Å—ã–ª–∫–∏:</b>
‚Ä¢ Grafana: http://192.168.1.100:3000
‚Ä¢ Prometheus: http://192.168.1.100:9091"
    
    send_telegram "$TELEGRAM_MESSAGE"
    log "üì± –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram" "$RED"
    exit 1
    
elif [ $TOTAL_WARNINGS -gt 0 ]; then
    # –¢–û–õ–¨–ö–û –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
    log "üü° –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è" "$YELLOW"
    
    WARNING_LIST=$(printf "‚Ä¢ %s\n" "${WARNINGS[@]}")
    HEALTHY_LIST=$(printf "‚Ä¢ %s\n" "${HEALTHY_SERVICES[@]:0:10}")  # –ü–µ—Ä–≤—ã–µ 10
    
    TELEGRAM_MESSAGE="‚ö†Ô∏è  <b>AVTOSVECHI - –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø</b>

<b>–í—Ä–µ–º—è:</b> $(date '+%d.%m.%Y %H:%M:%S')

<b>üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ($TOTAL_WARNINGS):</b>
$WARNING_LIST

<b>‚úÖ –†–∞–±–æ—Ç–∞—é—Ç ($TOTAL_HEALTHY):</b>
$HEALTHY_LIST$([ $TOTAL_HEALTHY -gt 10 ] && echo "\n    ... –∏ –µ—â—ë $((TOTAL_HEALTHY - 10)) —Å–µ—Ä–≤–∏—Å–æ–≤" || echo "")

<b>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ:</b>
‚Ä¢ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º —Ä–∞–±–æ—Ç–∞—é—Ç
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
‚Ä¢ –õ–æ–≥–∏: $LOG_FILE"
    
    send_telegram "$TELEGRAM_MESSAGE"
    log "üì± –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ Telegram" "$YELLOW"
    exit 0
    
else
    # –í–°–Å –û–ö - —Ç–æ–ª—å–∫–æ daily report
    log "‚úÖ –í–°–ï –°–ò–°–¢–ï–ú–´ –†–ê–ë–û–¢–ê–Æ–¢ –ù–û–†–ú–ê–õ–¨–ù–û" "$GREEN"
    
    # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –≤ 8 —É—Ç—Ä–∞
    CURRENT_HOUR=$(date +%H)
    if [ "$CURRENT_HOUR" = "08" ]; then
        HEALTHY_LIST=$(printf "‚Ä¢ %s\n" "${HEALTHY_SERVICES[@]:0:15}")
        
        TELEGRAM_MESSAGE="‚úÖ <b>AVTOSVECHI - –ï–ñ–ï–î–ù–ï–í–ù–´–ô –û–¢–ß–ï–¢</b>

<b>–í—Ä–µ–º—è:</b> $(date '+%d.%m.%Y %H:%M:%S')
<b>–î–µ–Ω—å –±–µ–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤!</b> üéâ

<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ –°–µ—Ä–≤–∏—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç: $TOTAL_HEALTHY
‚Ä¢ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $RUNNING_CONTAINERS
‚Ä¢ –ü–∞–º—è—Ç—å: ${MEM_PERCENT}% (${MEM_USED}MB/${MEM_TOTAL}MB)
‚Ä¢ –ù–∞–≥—Ä—É–∑–∫–∞ CPU: $CPU_LOAD
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: $DISK_USAGE

<b>‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</b>
$HEALTHY_LIST$([ $TOTAL_HEALTHY -gt 15 ] && echo "\n    ... –∏ –µ—â—ë $((TOTAL_HEALTHY - 15)) —Å–µ—Ä–≤–∏—Å–æ–≤" || echo "")

<b>üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</b>
‚Ä¢ Grafana: http://192.168.1.100:3000
‚Ä¢ Prometheus: http://192.168.1.100:9091
‚Ä¢ cAdvisor: http://192.168.1.100:8081

<b>üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á
2. –û–±–Ω–æ–≤–∏—Ç—å –±–µ–∫–∞–ø—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ"
        
        send_telegram "$TELEGRAM_MESSAGE"
        log "üì± –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –≤ Telegram" "$GREEN"
    fi
    
    exit 0
fi
