#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¢—Ä–∏–∞–¥—ã –ê–≥–µ–Ω—Ç–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∫–∞–≤—ã—á–µ–∫
"""

import os

def create_full_plan():
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω"""
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    content_lines = [
        "# üè≠ –ü–õ–ê–ù: ¬´–¢–†–ò–ê–î–ê ‚Äî –ü–†–û–ú–´–®–õ–ï–ù–ù–´–ô –°–¢–ê–ù–î–ê–†–¢¬ª (v5.0)",
        "## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
        "",
        "### üìã –ú–ï–¢–ê–î–ê–ù–ù–´–ï",
        "- **–ü—Ä–æ–µ–∫—Ç:** AUTOSHOP / OPS-AGENT",
        "- **–ú–∏—Å—Å–∏—è:** ¬´–¢—Ä–∏–∞–¥–∞ –ê–≥–µ–Ω—Ç–æ–≤¬ª",
        "- **–í–µ—Ä—Å–∏—è:** 5.0 (–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)",
        "- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û",
        "- **–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2026-01-15",
        "",
        "---",
        "",
        "## üèóÔ∏è 1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´",
        "",
        "### 1.1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –¢—Ä–∏–∞–¥—ã",
        '```',
        '        [–ò–ù–¶–ò–î–ï–ù–¢]',
        '            ‚îÇ',
        '    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê',
        '    ‚ñº       ‚ñº       ‚ñº',
        '  üëÅÔ∏è       ü§ñ       üß†',
        'WATCHER  EXECUTOR  SOLVER',
        '  ‚îÇ        ‚îÇ        ‚îÇ',
        '  ‚ñº        ‚ñº        ‚ñº',
        '[–§–ò–ö–°–ê–¶–ò–Ø] [–£–ü–†–ê–í–õ–ï–ù–ò–ï] [–ê–ù–ê–õ–ò–ó]',
        '    ‚îÇ        ‚îÇ        ‚îÇ',
        '    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò',
        '            ‚ñº',
        '      [–†–ê–ó–†–ï–®–ï–ù–ò–ï]',
        '```',
        "",
        "### 1.2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã",
        "",
        "#### üëÅÔ∏è WATCHER AGENT (¬´–ì–ª–∞–∑–∞¬ª)",
        "**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.",
        "- **–ü–æ—Ä—Ç:** 9090",
        "- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** HTTP/Prometheus",
        "- **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç:** API (8000), Shell-Agent (8001), PostgreSQL",
        "- **–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 30 —Å–µ–∫—É–Ω–¥",
        "- **–ú–µ—Ç—Ä–∏–∫–∏:** Prometheus format",
        "- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** Graceful shutdown, —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤, health checks",
        "",
        "#### ü§ñ EXECUTOR AGENT (¬´–†—É–∫–∏¬ª)",
        "**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π —á–µ—Ä–µ–∑ Telegram, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥.",
        "- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** Telegram Bot API",
        "- **–ö–æ–º–∞–Ω–¥—ã:** `/start`, `/help`, `/status`, `/incidents`, `/restart`",
        "- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Rate limiting (5 –∫–æ–º–∞–Ω–¥/–º–∏–Ω), whitelist –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "- **–ê—É–¥–∏—Ç:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `audit_log_executor`",
        "- **–ü–∞–Ω–µ–ª—å:** –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
        "",
        "#### üß† SOLVER AGENT (¬´–ú–æ–∑–≥¬ª)",
        "**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π.",
        "- **–ü–æ—Ä—Ç:** 8080",
        "- **–î–≤–∏–∂–æ–∫:** –ü—Ä–∞–≤–∏–ª–∞ (YAML-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)",
        "- **API:** REST –¥–ª—è health checks –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞–º–∏",
        "- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è ML-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",
        "- **–ü—Ä–∞–≤–∏–ª–∞:** `solver-agent/rules.yaml`",
        "",
        "---",
        "",
        "## üóÉÔ∏è 2. –ë–ê–ó–ê –î–ê–ù–ù–´–• (PostgreSQL)",
        "",
        "### 2.1. –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö",
        '```sql',
        "-- incidents: —Ç–∞–±–ª–∏—Ü–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤",
        "CREATE TABLE incidents (",
        "    id SERIAL PRIMARY KEY,",
        "    service_name VARCHAR(64) NOT NULL,",
        "    error_type VARCHAR(128) NOT NULL,",
        "    status VARCHAR(32) DEFAULT 'new' CHECK (...),",
        "    metadata JSONB DEFAULT '{}',",
        "    created_at TIMESTAMP DEFAULT NOW()",
        ");",
        "",
        "-- knowledge_base: –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
        "CREATE TABLE knowledge_base (",
        "    error_pattern VARCHAR(512),",
        "    playbook_id INTEGER REFERENCES playbooks(id),",
        "    confidence_score FLOAT CHECK (0.0-1.0),",
        "    tags TEXT[] DEFAULT '{}'",
        ");",
        "",
        "-- audit_log_executor: –∞—É–¥–∏—Ç –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞",
        "CREATE TABLE audit_log_executor (",
        "    user_id BIGINT NOT NULL,",
        "    command TEXT NOT NULL,",
        "    result TEXT,",
        "    timestamp TIMESTAMP DEFAULT NOW()",
        ");",
        '```',
        "",
        "### 2.2. –ò–Ω–¥–µ–∫—Å—ã (–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã)",
        "- `idx_incidents_service_name` ‚Äî –ø–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–≤–∏—Å—É",
        "- `idx_incidents_created_at` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã",
        "- `idx_knowledge_base_error_pattern` ‚Äî GIN –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞",
        "- `idx_audit_log_timestamp` ‚Äî –∞–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
    ]
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏
    content = "\n".join(content_lines)
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é docs –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs("docs", exist_ok=True)
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
    with open("docs/TRINITY_AGENTS_PLAN_FULL.md", "w", encoding="utf-8") as f:
        f.write(content)
    
    print("‚úÖ –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω —Å–æ–∑–¥–∞–Ω: docs/TRINITY_AGENTS_PLAN_FULL.md")
    return True

def update_plan_link():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–ª–∞–Ω–µ"""
    try:
        with open("project/PLAN.md", "r", encoding="utf-8") as f:
            content = f.read()
        
        # –ó–∞–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É
        new_content = content.replace(
            "./docs/TRINITY_AGENTS_PLAN.md",
            "../docs/TRINITY_AGENTS_PLAN_FULL.md"
        )
        
        with open("project/PLAN.md", "w", encoding="utf-8") as f:
            f.write(new_content)
        
        print("‚úÖ –°—Å—ã–ª–∫–∞ –≤ project/PLAN.md –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: {e}")
        return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¢—Ä–∏–∞–¥—ã –ê–≥–µ–Ω—Ç–æ–≤...")
    
    if create_full_plan() and update_plan_link():
        print("\nüéâ –ü–û–õ–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –°–û–ó–î–ê–ù–ê!")
        print("–§–∞–π–ª: docs/TRINITY_AGENTS_PLAN_FULL.md")
        print("–°—Å—ã–ª–∫–∞ –≤ –ø–ª–∞–Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        return 0
    else:
        print("\n‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏")
        return 1

if __name__ == "__main__":
    exit(main())
